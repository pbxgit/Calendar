<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OurCal - Collaborative Calendar</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/pbxgit/Calendar/main/favicon.png">

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />

    <style>
        /* --- MODERN UI AESTHETICS --- */
        :root {
            --font-family: 'Inter', sans-serif;
            --bg-color: #f6f8fa;
            --nav-bg: #ffffff;
            --content-bg: #ffffff;
            --detail-panel-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6a737d;
            --border-color: #e1e4e8;
            --primary-accent: #2188ff;
            --primary-accent-light: #e8f3ff;
            --danger-color: #d73a49;
            --success-color: #28a745;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --bg-color: #0d1117;
            --nav-bg: #161b22;
            --content-bg: #161b22;
            --detail-panel-bg: #0d1117;
            --text-primary: #e6edf3;
            --text-secondary: #7d8590;
            --border-color: #30363d;
            --primary-accent-light: rgba(56, 139, 253, 0.15);
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            overflow: hidden;
            font-size: 14px;
        }

        /* --- LOGIN SCREEN --- */
        #auth-section {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            transition: opacity 0.3s ease-in-out;
        }
        .login-container { background-color: var(--content-bg); border-radius: 12px; padding: 40px; text-align: center; box-shadow: var(--shadow); width: 100%; max-width: 400px; border: 1px solid var(--border-color); }
        .login-container h2 { font-weight: 700; margin-bottom: 8px; }
        .login-container .btn { border-radius: 8px; padding: 10px; font-weight: 500; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-primary); }
        [data-theme="dark"] .login-container .btn { background-color: #21262d; }

        /* --- MAIN APP LAYOUT --- */
        #main-app { display: flex; height: 100vh; }
        .main-nav { width: 70px; background-color: var(--nav-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 100; }
        .content-area { flex-grow: 1; padding: 24px; display: flex; flex-direction: column; overflow: hidden; }
        .detail-panel { width: 350px; background-color: var(--detail-panel-bg); border-left: 1px solid var(--border-color); padding: 24px; overflow-y: auto; transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 99; }
        .detail-panel.is-open { transform: translateX(0); }
        .view { display: none; height: 100%; }
        .view.active { display: block; }
        .d-none { display: none !important; }

        /* --- COMPONENTS --- */
        /* Nav */
        .main-nav .logo { margin-bottom: 30px; }
        .nav-item { cursor: pointer; color: var(--text-secondary); padding: 12px; border-radius: 8px; margin-bottom: 10px; transition: background-color 0.2s, color 0.2s; }
        .nav-item:hover { color: var(--primary-accent); background-color: var(--primary-accent-light); }
        .nav-item.active { color: var(--primary-accent); background-color: var(--primary-accent-light); }
        .nav-item i { font-size: 24px; }
        .sidebar-footer { margin-top: auto; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        .theme-toggle { cursor: pointer; margin-top: 15px; }

        /* Calendar View */
        #calendar-view { display: flex; flex-direction: column; height: 100%; }
        #calendar-container { flex-grow: 1; background-color: var(--content-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; }
        .fc { border: none !important; height: 100%; }
        .fc .fc-toolbar-title { font-size: 1.5em !important; font-weight: 600; }
        .fc .fc-button { background-color: transparent !important; color: var(--text-primary) !important; border: 1px solid var(--border-color) !important; box-shadow: none !important; }
        .fc .fc-button-primary:not(:disabled).fc-button-active, .fc .fc-button-primary:not(:disabled):active { background-color: var(--primary-accent) !important; color: white !important; }
        .fc-daygrid-day.fc-day-today { background-color: var(--primary-accent-light) !important; }
        .fc-event { border: none !important; font-weight: 500; padding: 2px 6px; }
        .fc-event-main { color: var(--text-primary) !important; }
        .fc-event[data-type="event"] { background-color: var(--primary-accent-light) !important; }
        .fc-event[data-type="task"] { background-color: #e8e8e8 !important; }
        .fc-event[data-type="task"][data-completed="true"] { text-decoration: line-through; opacity: 0.6; }

        /* Detail Panel */
        .detail-panel-header h3 { margin: 0; font-weight: 600; font-size: 1.2rem; }
        .detail-panel-header .close-btn { cursor: pointer; color: var(--text-secondary); }
        .list-group-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid var(--border-color); background-color: var(--bg-color); }
        .list-group-item.task .form-check-input { margin-top: 0; }
        .list-group-item .task-title { flex-grow: 1; }
        .list-group-item .task-title.completed { text-decoration: line-through; color: var(--text-secondary); }
        .delete-btn { color: var(--text-secondary); cursor: pointer; visibility: hidden; }
        .list-group-item:hover .delete-btn { visibility: visible; }
        .delete-btn:hover { color: var(--danger-color); }
        .form-control, .btn { border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-color); }
        .btn-primary { background-color: var(--primary-accent); border-color: var(--primary-accent); color: white; }

        /* History View */
        #history-feed { max-width: 800px; margin: 0 auto; }
        .history-item { display: flex; gap: 15px; padding: 15px; border-bottom: 1px solid var(--border-color); }
        .history-item-avatar img { width: 35px; height: 35px; border-radius: 50%; }
        .history-item-content strong { font-weight: 600; }
        .history-item-time { font-size: 0.8em; color: var(--text-secondary); }
    </style>
</head>
<body>

    <!-- Authentication Screen -->
    <div id="auth-section">
        <div class="login-container">
            <img src="https://raw.githubusercontent.com/pbxgit/Calendar/main/favicon.png" alt="logo" width="50" class="mb-3">
            <h2>Welcome to OurCal</h2>
            <p class="text-secondary mb-4">A shared calendar to keep you both in sync.</p>
            <div class="d-grid gap-2">
                <button id="google-login-btn" class="btn"><img src="https://raw.githubusercontent.com/pbxgit/Calendar/main/google-logo.svg" alt="Google" width="20" class="me-2"> Sign in with Google</button>
                <button id="github-login-btn" class="btn"><img src="https://raw.githubusercontent.com/pbxgit/Calendar/main/github-logo.svg" alt="GitHub" width="20" class="me-2"> Sign in with GitHub</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="d-none">
        <!-- Left Navigation -->
        <nav class="main-nav">
            <img src="https://raw.githubusercontent.com/pbxgit/Calendar/main/favicon.png" alt="logo" width="32" class="logo">
            <div class="nav-item active" data-view="calendar-view" title="Calendar"><i class="bi bi-calendar3"></i></div>
            <div class="nav-item" data-view="history-view" title="Activity"><i class="bi bi-clock-history"></i></div>
            <div class="sidebar-footer">
                <div id="user-profile"></div>
                <div class="theme-toggle nav-item" id="theme-toggle" title="Toggle Theme"><i class="bi bi-moon-stars"></i></div>
                <div class="nav-item" id="logout-btn" title="Logout"><i class="bi bi-box-arrow-right"></i></div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="content-area">
            <div id="calendar-view" class="view active">
                <div id="calendar-container"></div>
            </div>
            <div id="history-view" class="view">
                <h2 class="mb-4">Activity Feed</h2>
                <div id="history-feed" class="overflow-auto h-100"></div>
            </div>
        </main>

        <!-- Right Detail Panel -->
        <aside class="detail-panel" id="detail-panel">
            <div class="detail-panel-header d-flex justify-content-between align-items-center mb-4">
                <h3 id="detail-panel-date"></h3>
                <i class="bi bi-x-lg close-btn" id="close-panel-btn"></i>
            </div>
            
            <!-- Events Section -->
            <h5>Events</h5>
            <div id="event-list" class="mb-4"></div>
            <form id="add-event-form" class="d-flex gap-2 mb-4">
                <input type="text" id="event-title-input" class="form-control form-control-sm" placeholder="Add an event..." required>
                <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i></button>
            </form>

            <!-- Tasks Section -->
            <h5>Daily Tasks</h5>
            <div id="task-list" class="mb-4"></div>
            <form id="add-task-form" class="d-flex gap-2">
                <input type="text" id="task-title-input" class="form-control form-control-sm" placeholder="Add a task..." required>
                <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i></button>
            </form>
        </aside>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- JS Libraries -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.js'></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBghGrPLr7_iC46u1Phs83vd1i-47zstUs",
            authDomain: "calendar-pbx21.firebaseapp.com",
            projectId: "calendar-pbx21",
            storageBucket: "calendar-pbx21.appspot.com",
            messagingSenderId: "304190482123",
            appId: "1:304190482123:web:2a8415125467565a1e9d4e",
            measurementId: "G-YCNG7QXRR2"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // --- GLOBAL STATE ---
        let calendar;
        let currentUser = null;
        let selectedDate = null;
        let unsubscribeEvents = null;

        // --- DOM ELEMENTS ---
        const authSection = document.getElementById('auth-section');
        const mainApp = document.getElementById('main-app');
        const detailPanel = document.getElementById('detail-panel');

        // --- THEME MANAGEMENT ---
        const themeToggle = document.getElementById('theme-toggle');
        const setInitialTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            themeToggle.querySelector('i').className = savedTheme === 'dark' ? 'bi bi-sun' : 'bi bi-moon-stars';
        };
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            setInitialTheme();
        });

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setInitialTheme();
            auth.onAuthStateChanged(user => {
                if (user && !user.isAnonymous) {
                    currentUser = user;
                    authSection.classList.add('d-none');
                    mainApp.classList.remove('d-none');
                    initializeApp();
                } else {
                    currentUser = null;
                    authSection.classList.remove('d-none');
                    mainApp.classList.add('d-none');
                    if (calendar) calendar.destroy();
                    if (unsubscribeEvents) unsubscribeEvents();
                }
            });
            setupAuthEventListeners();
        });

        function initializeApp() {
            updateUserInfoUI(currentUser);
            setupAppEventListeners();
            initializeCalendar();
            loadAllEvents();
            loadHistory();
        }

        // --- UI & AUTHENTICATION ---
        function updateUserInfoUI(user) {
            document.getElementById('user-profile').innerHTML = `<img src="${user.photoURL}" alt="${user.displayName}" class="user-avatar" title="${user.displayName}">`;
        }

        function setupAuthEventListeners() {
            document.getElementById('google-login-btn').addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));
            document.getElementById('github-login-btn').addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GithubAuthProvider()));
        }

        // --- NAVIGATION & VIEWS ---
        function setupAppEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
            document.getElementById('close-panel-btn').addEventListener('click', () => detailPanel.classList.remove('is-open'));

            document.querySelectorAll('.main-nav .nav-item[data-view]').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelector('.main-nav .nav-item.active').classList.remove('active');
                    item.classList.add('active');
                    
                    document.querySelector('.view.active').classList.remove('active');
                    document.getElementById(item.dataset.view).classList.add('active');
                });
            });

            // Form Submissions in Detail Panel
            document.getElementById('add-event-form').addEventListener('submit', (e) => handleItemAdd(e, 'event'));
            document.getElementById('add-task-form').addEventListener('submit', (e) => handleItemAdd(e, 'task'));
        }

        // --- CALENDAR LOGIC ---
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar-container');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                height: '100%',
                selectable: true,
                editable: true,
                dateClick: (info) => {
                    selectedDate = info.dateStr;
                    renderDetailPanel(selectedDate);
                    detailPanel.classList.add('is-open');
                },
                eventDrop: (info) => {
                    const { id, title } = info.event;
                    const newStart = info.event.start.toISOString().split('T')[0];
                    db.collection('events').doc(id).update({ start: newStart });
                    logHistory('moved', { title });
                },
                 eventDidMount: function(info) {
                    info.el.setAttribute('data-type', info.event.extendedProps.type);
                    if(info.event.extendedProps.completed) {
                         info.el.setAttribute('data-completed', 'true');
                    }
                }
            });
            calendar.render();
        }

        function loadAllEvents() {
             if (unsubscribeEvents) unsubscribeEvents();
             unsubscribeEvents = db.collection('events').onSnapshot(snapshot => {
                const events = snapshot.docs.map(doc => ({
                    id: doc.id,
                    title: doc.data().title,
                    start: doc.data().start,
                    allDay: true,
                    extendedProps: {
                        type: doc.data().type,
                        completed: doc.data().completed
                    }
                }));
                if (calendar) {
                    calendar.removeAllEventSources();
                    calendar.addEventSource(events);
                }
            });
        }
        
        // --- DETAIL PANEL LOGIC ---
        function renderDetailPanel(dateStr) {
             const date = new Date(dateStr + 'T00:00:00');
             document.getElementById('detail-panel-date').textContent = date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
             
             db.collection('events').where('start', '==', dateStr).onSnapshot(snapshot => {
                 const eventList = document.getElementById('event-list');
                 const taskList = document.getElementById('task-list');
                 eventList.innerHTML = '';
                 taskList.innerHTML = '';

                 if (snapshot.empty) {
                     eventList.innerHTML = '<p class="text-secondary small">No events for this day.</p>';
                 }

                 snapshot.docs.forEach(doc => {
                     const item = doc.data();
                     const itemEl = document.createElement('div');
                     
                     if (item.type === 'event') {
                         itemEl.className = 'list-group-item event';
                         itemEl.innerHTML = `<span>${item.title}</span><div class="ms-auto"><i class="bi bi-trash delete-btn" data-id="${doc.id}" data-title="${item.title}"></i></div>`;
                         eventList.appendChild(itemEl);
                     } else if (item.type === 'task') {
                         itemEl.className = 'list-group-item task';
                         itemEl.innerHTML = `
                            <input class="form-check-input" type="checkbox" ${item.completed ? 'checked' : ''} data-id="${doc.id}">
                            <span class="task-title ${item.completed ? 'completed' : ''}">${item.title}</span>
                            <div class="ms-auto"><i class="bi bi-trash delete-btn" data-id="${doc.id}" data-title="${item.title}"></i></div>
                         `;
                         taskList.appendChild(itemEl);
                     }
                 });
                 attachItemActionListeners();
             });
        }
        
        function attachItemActionListeners() {
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const id = e.target.dataset.id;
                    const title = e.target.dataset.title;
                    if (confirm(`Delete "${title}"?`)) {
                        db.collection('events').doc(id).delete();
                        logHistory('deleted', { title });
                    }
                }
            });

            document.querySelectorAll('.task .form-check-input').forEach(box => {
                box.onchange = (e) => {
                    db.collection('events').doc(e.target.dataset.id).update({ completed: e.target.checked });
                }
            });
        }

        async function handleItemAdd(e, type) {
            e.preventDefault();
            const inputId = type === 'event' ? 'event-title-input' : 'task-title-input';
            const input = document.getElementById(inputId);
            const title = input.value.trim();

            if (title && selectedDate) {
                const newItem = {
                    title: title,
                    start: selectedDate,
                    type: type,
                    createdBy: {
                        uid: currentUser.uid,
                        name: currentUser.displayName,
                        avatar: currentUser.photoURL
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    ...(type === 'task' && { completed: false })
                };
                await db.collection('events').add(newItem);
                logHistory('created', { title: title });
                input.value = '';
            }
        }

        // --- HISTORY & LOGGING ---
        function logHistory(action, data) {
            db.collection('history').add({
                action: action, // created, deleted, moved
                itemTitle: data.title,
                user: { name: currentUser.displayName, avatar: currentUser.photoURL },
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function loadHistory() {
            db.collection('history').orderBy('timestamp', 'desc').limit(50).onSnapshot(snapshot => {
                const feed = document.getElementById('history-feed');
                feed.innerHTML = '';
                snapshot.forEach(doc => {
                    const entry = doc.data();
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="history-item-avatar"><img src="${entry.user.avatar}" alt="${entry.user.name}"></div>
                        <div class="history-item-content">
                            <p class="mb-0"><strong>${entry.user.name}</strong> ${entry.action} "${entry.itemTitle}"</p>
                            <span class="history-item-time">${entry.timestamp ? entry.timestamp.toDate().toLocaleString() : ''}</span>
                        </div>
                    `;
                    feed.appendChild(item);
                });
            });
        }
    </script>
</body>
</html>
